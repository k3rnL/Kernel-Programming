global idt_load, _asm_default_int_asm
extern idtr, isr_default_int

idt_load:
	lidt [idtr]
	ret

%macro save_register 0
	pusha                    ; Pushes edi,esi,ebp,esp,ebx,edx,ecx,eax

	mov ax, ds               ; Lower 16-bits of eax = ds.
	push eax                 ; save the data segment descriptor

	mov ax, 0x10  ; load the kernel data segment descriptor
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
%endmacro	

%macro restore_register 0
	pop eax        ; reload the original data segment descriptor
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax

	popa                     ; Pops edi,esi,ebp...
	add esp, 8     ; Cleans up the pushed error code and pushed ISR number
	sti
	iret           ; pops 5 things at once: CS, EIP, EFLAGS, SS, and ESP
%endmacro	
	
%macro ISR_NOERRCODE 2  ; define a macro, taking interrupt code and handler
	[GLOBAL interrupt_%1]        ; %1 accesses the first parameter.
	interrupt_%1:
		cli
		push 0
		push %1
		save_register
		jmp %2
		restore_register
%endmacro

%macro ISR_ERRCODE 2
	[GLOBAL interrupt_%1]
	interrup_%1:
		cli
		push %1
		save_register
		jmp %2
		restore_regiter
%endmacro

global isr_oui
isr_oui:
   pusha                    ; Pushes edi,esi,ebp,esp,ebx,edx,ecx,eax

   mov ax, ds               ; Lower 16-bits of eax = ds.
   push eax                 ; save the data segment descriptor

   mov ax, 0x10  ; load the kernel data segment descriptor
   mov ds, ax
   mov es, ax
   mov fs, ax
   mov gs, ax

   call isr_default_int

   pop eax        ; reload the original data segment descriptor
   mov ds, ax
   mov es, ax
   mov fs, ax
   mov gs, ax

   popa                     ; Pops edi,esi,ebp...
   add esp, 8     ; Cleans up the pushed error code and pushed ISR number
   sti
   iret           ; pops 5 things at once: CS, EIP, EFLAGS, SS, and ESP
	
ISR_NOERRCODE 0, isr_default_int
ISR_NOERRCODE 1, isr_default_int
ISR_NOERRCODE 2, isr_default_int
ISR_NOERRCODE 3, isr_default_int
ISR_NOERRCODE 4, isr_default_int
ISR_NOERRCODE 5, isr_default_int
ISR_NOERRCODE 6, isr_default_int
ISR_NOERRCODE 7, isr_default_int
ISR_NOERRCODE 8, isr_default_int
ISR_NOERRCODE 9, isr_default_int
ISR_NOERRCODE 10, isr_default_int
ISR_NOERRCODE 11, isr_default_int
ISR_NOERRCODE 12, isr_default_int
ISR_NOERRCODE 13, isr_default_int
ISR_NOERRCODE 14, isr_default_int
ISR_NOERRCODE 15, isr_default_int
ISR_NOERRCODE 16, isr_default_int
ISR_NOERRCODE 17, isr_default_int
ISR_NOERRCODE 18, isr_default_int
ISR_NOERRCODE 19, isr_default_int
ISR_NOERRCODE 20, isr_default_int
ISR_NOERRCODE 21, isr_default_int
ISR_NOERRCODE 22, isr_default_int
ISR_NOERRCODE 23, isr_default_int
ISR_NOERRCODE 24, isr_default_int
ISR_NOERRCODE 25, isr_default_int
ISR_NOERRCODE 26, isr_default_int
ISR_NOERRCODE 27, isr_default_int
ISR_NOERRCODE 28, isr_default_int
ISR_NOERRCODE 29, isr_default_int
ISR_NOERRCODE 30, isr_default_int
ISR_NOERRCODE 31, isr_default_int
ISR_NOERRCODE 32, isr_default_int
ISR_NOERRCODE 33, isr_default_int
ISR_NOERRCODE 34, isr_default_int
ISR_NOERRCODE 35, isr_default_int
ISR_NOERRCODE 36, isr_default_int
ISR_NOERRCODE 37, isr_default_int
ISR_NOERRCODE 38, isr_default_int
ISR_NOERRCODE 39, isr_default_int
ISR_NOERRCODE 40, isr_default_int
ISR_NOERRCODE 41, isr_default_int
ISR_NOERRCODE 42, isr_default_int
ISR_NOERRCODE 43, isr_default_int
ISR_NOERRCODE 44, isr_default_int
ISR_NOERRCODE 45, isr_default_int
ISR_NOERRCODE 46, isr_default_int
ISR_NOERRCODE 47, isr_default_int
ISR_NOERRCODE 48, isr_default_int
ISR_NOERRCODE 49, isr_default_int
ISR_NOERRCODE 50, isr_default_int
ISR_NOERRCODE 51, isr_default_int
ISR_NOERRCODE 52, isr_default_int
ISR_NOERRCODE 53, isr_default_int
ISR_NOERRCODE 54, isr_default_int
ISR_NOERRCODE 55, isr_default_int
ISR_NOERRCODE 56, isr_default_int
ISR_NOERRCODE 57, isr_default_int
ISR_NOERRCODE 58, isr_default_int
ISR_NOERRCODE 59, isr_default_int
ISR_NOERRCODE 60, isr_default_int
ISR_NOERRCODE 61, isr_default_int
ISR_NOERRCODE 62, isr_default_int
ISR_NOERRCODE 63, isr_default_int
ISR_NOERRCODE 64, isr_default_int
ISR_NOERRCODE 65, isr_default_int
ISR_NOERRCODE 66, isr_default_int
ISR_NOERRCODE 67, isr_default_int
ISR_NOERRCODE 68, isr_default_int
ISR_NOERRCODE 69, isr_default_int
ISR_NOERRCODE 70, isr_default_int
ISR_NOERRCODE 71, isr_default_int
ISR_NOERRCODE 72, isr_default_int
ISR_NOERRCODE 73, isr_default_int
ISR_NOERRCODE 74, isr_default_int
ISR_NOERRCODE 75, isr_default_int
ISR_NOERRCODE 76, isr_default_int
ISR_NOERRCODE 77, isr_default_int
ISR_NOERRCODE 78, isr_default_int
ISR_NOERRCODE 79, isr_default_int
ISR_NOERRCODE 80, isr_default_int
ISR_NOERRCODE 81, isr_default_int
ISR_NOERRCODE 82, isr_default_int
ISR_NOERRCODE 83, isr_default_int
ISR_NOERRCODE 84, isr_default_int
ISR_NOERRCODE 85, isr_default_int
ISR_NOERRCODE 86, isr_default_int
ISR_NOERRCODE 87, isr_default_int
ISR_NOERRCODE 88, isr_default_int
ISR_NOERRCODE 89, isr_default_int
ISR_NOERRCODE 90, isr_default_int
ISR_NOERRCODE 91, isr_default_int
ISR_NOERRCODE 92, isr_default_int
ISR_NOERRCODE 93, isr_default_int
ISR_NOERRCODE 94, isr_default_int
ISR_NOERRCODE 95, isr_default_int
ISR_NOERRCODE 96, isr_default_int
ISR_NOERRCODE 97, isr_default_int
ISR_NOERRCODE 98, isr_default_int
ISR_NOERRCODE 99, isr_default_int
ISR_NOERRCODE 100, isr_default_int
ISR_NOERRCODE 101, isr_default_int
ISR_NOERRCODE 102, isr_default_int
ISR_NOERRCODE 103, isr_default_int
ISR_NOERRCODE 104, isr_default_int
ISR_NOERRCODE 105, isr_default_int
ISR_NOERRCODE 106, isr_default_int
ISR_NOERRCODE 107, isr_default_int
ISR_NOERRCODE 108, isr_default_int
ISR_NOERRCODE 109, isr_default_int
ISR_NOERRCODE 110, isr_default_int
ISR_NOERRCODE 111, isr_default_int
ISR_NOERRCODE 112, isr_default_int
ISR_NOERRCODE 113, isr_default_int
ISR_NOERRCODE 114, isr_default_int
ISR_NOERRCODE 115, isr_default_int
ISR_NOERRCODE 116, isr_default_int
ISR_NOERRCODE 117, isr_default_int
ISR_NOERRCODE 118, isr_default_int
ISR_NOERRCODE 119, isr_default_int
ISR_NOERRCODE 120, isr_default_int
ISR_NOERRCODE 121, isr_default_int
ISR_NOERRCODE 122, isr_default_int
ISR_NOERRCODE 123, isr_default_int
ISR_NOERRCODE 124, isr_default_int
ISR_NOERRCODE 125, isr_default_int
ISR_NOERRCODE 126, isr_default_int
ISR_NOERRCODE 127, isr_default_int
ISR_NOERRCODE 128, isr_default_int
ISR_NOERRCODE 129, isr_default_int
ISR_NOERRCODE 130, isr_default_int
ISR_NOERRCODE 131, isr_default_int
ISR_NOERRCODE 132, isr_default_int
ISR_NOERRCODE 133, isr_default_int
ISR_NOERRCODE 134, isr_default_int
ISR_NOERRCODE 135, isr_default_int
ISR_NOERRCODE 136, isr_default_int
ISR_NOERRCODE 137, isr_default_int
ISR_NOERRCODE 138, isr_default_int
ISR_NOERRCODE 139, isr_default_int
ISR_NOERRCODE 140, isr_default_int
ISR_NOERRCODE 141, isr_default_int
ISR_NOERRCODE 142, isr_default_int
ISR_NOERRCODE 143, isr_default_int
ISR_NOERRCODE 144, isr_default_int
ISR_NOERRCODE 145, isr_default_int
ISR_NOERRCODE 146, isr_default_int
ISR_NOERRCODE 147, isr_default_int
ISR_NOERRCODE 148, isr_default_int
ISR_NOERRCODE 149, isr_default_int
ISR_NOERRCODE 150, isr_default_int
ISR_NOERRCODE 151, isr_default_int
ISR_NOERRCODE 152, isr_default_int
ISR_NOERRCODE 153, isr_default_int
ISR_NOERRCODE 154, isr_default_int
ISR_NOERRCODE 155, isr_default_int
ISR_NOERRCODE 156, isr_default_int
ISR_NOERRCODE 157, isr_default_int
ISR_NOERRCODE 158, isr_default_int
ISR_NOERRCODE 159, isr_default_int
ISR_NOERRCODE 160, isr_default_int
ISR_NOERRCODE 161, isr_default_int
ISR_NOERRCODE 162, isr_default_int
ISR_NOERRCODE 163, isr_default_int
ISR_NOERRCODE 164, isr_default_int
ISR_NOERRCODE 165, isr_default_int
ISR_NOERRCODE 166, isr_default_int
ISR_NOERRCODE 167, isr_default_int
ISR_NOERRCODE 168, isr_default_int
ISR_NOERRCODE 169, isr_default_int
ISR_NOERRCODE 170, isr_default_int
ISR_NOERRCODE 171, isr_default_int
ISR_NOERRCODE 172, isr_default_int
ISR_NOERRCODE 173, isr_default_int
ISR_NOERRCODE 174, isr_default_int
ISR_NOERRCODE 175, isr_default_int
ISR_NOERRCODE 176, isr_default_int
ISR_NOERRCODE 177, isr_default_int
ISR_NOERRCODE 178, isr_default_int
ISR_NOERRCODE 179, isr_default_int
ISR_NOERRCODE 180, isr_default_int
ISR_NOERRCODE 181, isr_default_int
ISR_NOERRCODE 182, isr_default_int
ISR_NOERRCODE 183, isr_default_int
ISR_NOERRCODE 184, isr_default_int
ISR_NOERRCODE 185, isr_default_int
ISR_NOERRCODE 186, isr_default_int
ISR_NOERRCODE 187, isr_default_int
ISR_NOERRCODE 188, isr_default_int
ISR_NOERRCODE 189, isr_default_int
ISR_NOERRCODE 190, isr_default_int
ISR_NOERRCODE 191, isr_default_int
ISR_NOERRCODE 192, isr_default_int
ISR_NOERRCODE 193, isr_default_int
ISR_NOERRCODE 194, isr_default_int
ISR_NOERRCODE 195, isr_default_int
ISR_NOERRCODE 196, isr_default_int
ISR_NOERRCODE 197, isr_default_int
ISR_NOERRCODE 198, isr_default_int
ISR_NOERRCODE 199, isr_default_int
ISR_NOERRCODE 200, isr_default_int
ISR_NOERRCODE 201, isr_default_int
ISR_NOERRCODE 202, isr_default_int
ISR_NOERRCODE 203, isr_default_int
ISR_NOERRCODE 204, isr_default_int
ISR_NOERRCODE 205, isr_default_int
ISR_NOERRCODE 206, isr_default_int
ISR_NOERRCODE 207, isr_default_int
ISR_NOERRCODE 208, isr_default_int
ISR_NOERRCODE 209, isr_default_int
ISR_NOERRCODE 210, isr_default_int
ISR_NOERRCODE 211, isr_default_int
ISR_NOERRCODE 212, isr_default_int
ISR_NOERRCODE 213, isr_default_int
ISR_NOERRCODE 214, isr_default_int
ISR_NOERRCODE 215, isr_default_int
ISR_NOERRCODE 216, isr_default_int
ISR_NOERRCODE 217, isr_default_int
ISR_NOERRCODE 218, isr_default_int
ISR_NOERRCODE 219, isr_default_int
ISR_NOERRCODE 220, isr_default_int
ISR_NOERRCODE 221, isr_default_int
ISR_NOERRCODE 222, isr_default_int
ISR_NOERRCODE 223, isr_default_int
ISR_NOERRCODE 224, isr_default_int
ISR_NOERRCODE 225, isr_default_int
ISR_NOERRCODE 226, isr_default_int
ISR_NOERRCODE 227, isr_default_int
ISR_NOERRCODE 228, isr_default_int
ISR_NOERRCODE 229, isr_default_int
ISR_NOERRCODE 230, isr_default_int
ISR_NOERRCODE 231, isr_default_int
ISR_NOERRCODE 232, isr_default_int
ISR_NOERRCODE 233, isr_default_int
ISR_NOERRCODE 234, isr_default_int
ISR_NOERRCODE 235, isr_default_int
ISR_NOERRCODE 236, isr_default_int
ISR_NOERRCODE 237, isr_default_int
ISR_NOERRCODE 238, isr_default_int
ISR_NOERRCODE 239, isr_default_int
ISR_NOERRCODE 240, isr_default_int
ISR_NOERRCODE 241, isr_default_int
ISR_NOERRCODE 242, isr_default_int
ISR_NOERRCODE 243, isr_default_int
ISR_NOERRCODE 244, isr_default_int
ISR_NOERRCODE 245, isr_default_int
ISR_NOERRCODE 246, isr_default_int
ISR_NOERRCODE 247, isr_default_int
ISR_NOERRCODE 248, isr_default_int
ISR_NOERRCODE 249, isr_default_int
ISR_NOERRCODE 250, isr_default_int
ISR_NOERRCODE 251, isr_default_int
ISR_NOERRCODE 252, isr_default_int
ISR_NOERRCODE 253, isr_default_int
ISR_NOERRCODE 254, isr_default_int
ISR_NOERRCODE 255, isr_default_int
